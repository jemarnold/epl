---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.path = "man/figures/README-",
    out.width = "100%",
    dpi = 300
)
```

# epl

<!-- badges: start -->

<!-- badges: end -->

*{epl}* is a repository of functions and scripts for common tasks for use by students in the UBC Environmental Physiology Laboratory.

## Website

For more information and vignettes on usage, please visit [the package website](https://jemarnold.github.io/epl/).

## Online App

A rudimentary implementation of some of the *{epl}* functions are available as [a *Shiny* app](jem-arnold.shinyapps.io/EPL-Parvo-App/) to read, clean, plot, and download Parvo metabolic data.



## Installation

You can install the development version of *{epl}* from [GitHub](https://github.com/jemarnold/epl) with:

``` r
## install.packages("remotes")
remotes::install_github("jemarnold/epl")

## explicitly request vignettes
remotes::install_github("jemarnold/epl", dependencies = TRUE, build_vignettes = TRUE)
```

## Usage

```{r}
#| label: setup
library(tidyr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(epl)

theme_set(theme_epl())
```

#### `example_epl()`

This helper function can be used to retrieve example data files included in *{epl}* to test processing functions.

```{r}
#| results: 'hide'
#| error: TRUE
example_epl()
#> [1] "parvo_binned.CSV"  "parvo_bxb.CSV"     "tymewear_live.csv"
#> [4] "tymewear_post.csv"

example_epl("parvo_binned")
#> [1] "C:/Program Files/R/R-4.5.1/library/epl/extdata/tymewear_live.csv"
```

### `read_parvo()`

```{r}
parvo <- read_parvo(example_epl("parvo_binned"), add_timestamp = TRUE)
parvo
```

### `read_tymewear()`

```{r}
tymelive <- read_tymewear(example_epl("tymewear_live"))
tymelive
```

### `replace_outliers()`

```{r}
tyme_data <- tymelive$data

vt_filtered <- replace_outliers(tyme_data$vt, width = 7, method = "median")

ggplot(tyme_data) +
    aes(x = time, y = vt) +
    ylab("Tidal Volume (L)") +
    scale_x_continuous(
        name = "Time (mm:ss)",
        breaks = breaks_timespan(),
        labels = format_hmmss
    ) +
    scale_colour_epl() +
    geom_line(aes(colour = "BR")) +
    geom_point(
        data = slice(tyme_data, which(vt_filtered != vt)),
        aes(y = vt, colour = "outliers")
    )
```

### `filter_data()`

`<under development>`

### `find_peaks()`

```{r}
ramp_data <- read_parvo(example_epl("parvo_ramp"))$data

peak_data <- find_peaks(
    ramp_data, 
    x = "TIME",
    y = "VO2", 
    span = 30,
    between = c(1500, 2000)
)
peak_data

VO2peak <- peak_data$VO2kg
VO2peak
```


### `theme_epl()` & custom `{ggplot2}` plotting functions

```{r}

ggplot(ramp_data) +
    aes(x = TIME) +
    labs(title = expression(
        Incremental~Ramp~and~dot(V)*O['2']~Verification~Assessment
    )) +
    coord_cartesian(ylim = c(0, NA)) +
    theme(
        panel.grid.major.y = element_line()
    ) +
    scale_x_continuous(
        name = "Time (mm:ss)",
        breaks = breaks_timespan(),
        labels = format_hmmss
    ) +
    scale_y_continuous(
        name = expression(bold(
            dot(V)*O['2']~~'|'~~dot(V)*CO['2']~'('*L%.%min^'-1'*')'
        )),
        expand = expansion(mult = 0)
    ) +
    scale_colour_manual(
        name = NULL,
        aesthetics = c("colour", "fill"),
        values = setNames(palette_epl()[c(6, 5)], c("VO2", "VCO2")),
    ) +
    guides(
        colour = guide_legend(override.aes = list(
            linewidth = 1, alpha = 1
        ))
    ) +
    geom_area(aes(y = VO2, colour = "VO2", fill = "VO2"), 
              alpha = 0.1, key_glyph = "path") +
    geom_line(aes(y = VCO2, colour = "VCO2")) +
    geom_point(data = peak_data, aes(x = TIME, y = VO2),
               size = 4, shape = 21, stroke = 1)
```


```{r}
scales::show_col(palette_epl()) ## visualise the colour palette
```

## To do

- Add digital filtering methods (e.g. Butterworth, smoothing spline, simple moving average, binning).

- Add mean peak value detection, i.e. for VÌ‡O~2~peak.

- Update EPL Parvo App.

- Create vignette for main package usage.

- Update `read_tymewear()` method for *"tymepost*" export file type.

- Add 4-parameter monoexponential curve fitting via `nls()` self-starting functions.

- ~~Add template display theme for `ggplot2` plotting.~~

- ~~Add local outlier filtering for metabolic data.~~
